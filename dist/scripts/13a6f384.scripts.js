"use strict";angular.module("vnbidding.github.ioApp",["firebase","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/user",{templateUrl:"views/user.html",controller:"UserCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("vnbidding.github.ioApp").controller("MainCtrl",["$scope","auth","models",function(a,b,c){a.auctions=c.Auction.get(),a.done=function(){return _.filter(a.auctions.all(),a.checkDone)},a.ongoing=function(){return _.reject(a.auctions.all(),a.checkDone)},a.createAuction=function(){var b=new c.Auction(a.newAuction);b.create(),a.newAuction=null,a.page=0},a.nextPage=function(){a.page++},a.goBack=function(){a.page--,a.page<0&&(a.page=0)},a.checkDone=function(a){return a.isDone()}}]),angular.module("vnbidding.github.ioApp").controller("UserCtrl",["$scope","auth","$rootScope","safeApply","angularFireCollection",function(a,b,c,d){a.login=function(a,c){b.login(a,c)},a.logout=function(){b.logout(),d(a)},a.bid=function(){var b=a.item.price,c=a.item.name;a.bids.add({user:a.user.username,price:b,name:c})}}]),angular.module("vnbidding.github.ioApp").factory("auth",["$rootScope","safeApply",function(a,b){var c=new Firebase("https://bidding.firebaseio.com"),d=new FirebaseAuthClient(c,function(b,c){c?a.$emit("login",c):b?a.$emit("loginError",b):a.$emit("logout")});return a.$on("login",function(c,d){a.user=d,"password"==d.provider&&(d.username=d.name=d.email),b(a)}),a.$on("logout",function(){delete a.user,b(a)}),a.auth={login:function(a,b){d.login(a,b)},logout:function(){d.logout()},loginError:function(a){alert(a)}}}]),angular.module("vnbidding.github.ioApp").factory("safeApply",["$rootScope",function(a){return function(b,c){b=b||a;var d=b.$root.$$phase;"$apply"==d||"$digest"==d?c&&b.$eval(c):c?b.$apply(c):b.$apply()}}]),angular.module("vnbidding.github.ioApp").factory("models",["angularFire","angularFireCollection","safeApply","$timeout","Collection","$rootScope",function(a,b,c,d,e,f){function g(a){_.extend(this,a)}var h={refUrls:{clockSkew:"https://bidding.firebaseio.com/.info/serverTimeOffset",auctions:"https://bidding.firebaseio.com/auctions",users:"https://bidding.firebaseio.com/users",products:"https://bidding.firebaseio.com/products"},serverValues:{}},i=(b(new Firebase(h.refUrls.auctions)),b(new Firebase(h.refUrls.users)),b(new Firebase(h.refUrls.products))),j=e(h.refUrls.auctions,g);g.prototype={toObject:function(){var a={};return angular.forEach(this,function(b,c){0!==c.indexOf("$")&&(a[c]=b)}),angular.fromJson(angular.toJson(a))},_getBidCollection:function(){return e(h.refUrls.auctions+"/"+this.$id+"/bids")},addBid:function(a){var b=this._getBidCollection();return b.add(a)},getBids:function(){var a=this._getBidCollection();return a._collection},create:function(){var a=this,b=a.product;if(!b)throw"Product should not be NULL";a.currentPrice=a.initPrice,a.currentBidder=f.user.name,a.endTime=new Date(a.endTime).getTime(),a.startTime&&(a.startTime=new Date(a.startTime).getTime()),j.add(a,{createdTime:"TIMESTAMP"}).then(function(b){a.startTime||(a.startTime=a.createdTime),b.ref.setWithPriority(a.toObject(),-1*a.createdTime)}),i.add(b)},bid:function(a){var b,c=this;a||(a=c.minStep),c.currentPrice+=a,c.currentBidder=f.user.name,b={price:c.currentPrice,createTime:Date.now()+h.serverValues.timeOffset,user:{id:f.user.id,username:f.user.username,name:f.user.name}},c.addBid(b),j.update(c.$id)},getTimeLeft:function(){var a=Date.now()+h.serverValues.timeOffset,b=this.endTime,d=b-a,e=new Date(d),f=~~(d/36e5),g=e.getMinutes(),i=e.getSeconds();return 15e3>d?"Đã xong":0>d?"Vửa xong":f>36?(setTimeout(c,36e5),~~(f/24)+" ngày"):f>1?(setTimeout(c,6e4),f+" tiếng"):g>=10?(setTimeout(c,1e3),"0:"+g+":"+i):(i=10>i?"0"+i:i,setTimeout(c,1e3),"0:0"+g+":"+i)},isDone:function(){var a=Date.now()+h.serverValues.timeOffset,b=this.endTime;return a>b}},g.get=function(){return j};var k=new Firebase(h.refUrls.clockSkew);return k.on("value",function(a){var b=a.val();h.serverValues.timeOffset=b,c()}),{config:h,Auction:g}}]).factory("Collection",["$timeout","$q",function(a,b){function c(b,c){function d(){var a=_.sortBy(f._collection,function(a){return a[".priority"]});f._collection=a}function e(a){return _.find(f._collection,function(b){return b.$id==a})}var f=this;this._collection=[],this._ctor=c||function(){},"string"==typeof b&&(b=new Firebase(b)),this._ref=b,this.findById=e,b.on("child_added",function(b){a(function(){var a=b.val(),c=b.getPriority(),g=b.name(),h=b.ref(),i=e(g);i||(i=new f._ctor(a),f._collection.push(i)),i[".priority"]=c,i.$id=g,i.$ref=h,d()})}),b.on("child_changed",function(b){a(function(){var a=b.name(),c=b.getPriority(),d=e(a);_.extend(d,b.val()),d[".priority"]=c})}),b.on("child_moved",function(b){a(function(){var a=b.name(),c=b.getPriority(),f=e(a);b.val(),f[".priority"]=c,d()})}),b.on("child_removed",function(b){a(function(){var a=b.name(),c=_.without(f._collection,e(a));f._collection=c})})}var d={};return c.prototype={add:function(a,c,d){var e=this._ref,f=this,g=b.defer(),h=g.promise;isNaN(c)||(d=c,c={});var i=angular.fromJson(angular.toJson(a));angular.forEach(c,function(a,b){i[b]=Firebase.ServerValue[a]});var j=e.push(i);return a.$id=j.name(),f._collection.push(a),isNaN(d)||j.setPriority(d),j.once("value",function(b){angular.extend(a,b.val()),g.resolve({snapshot:b,ref:j})}),h},update:function(a){var c="string"==typeof a?a:a.$id,d=this.findById(c),e=d.toObject(),f=b.defer(),g=f.promise;return d.$ref.set(e),d.$ref.once("value",function(a){f.resolve({snapshot:a,ref:d.$ref})}),g},all:function(){return this._collection}},function(a,b){return d[a]?d[a]:d[a]=new c(a,b)}}]);